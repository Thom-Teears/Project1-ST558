---
title: "<center> Project I </center>"
author: "<center>Avisek Choudhury</center>"
date: "<center>6/3/2019</center>"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# JSON File

There are several JSON data sets are available from federal/state/county/city or other sources. We have selected the <a href = "https://data.ct.gov/Health-and-Human-Services/Accidental-Drug-Related-Deaths-2012-2018/rybz-nyjw" > accidental drug related deaths from 2012-2018 dataset </a> from state of Connecticut.

# Reading JSON File

### Download and Examine the JSON file

After we have downloaded the JSON file from the above mentioned link we have examined it in the firefox. The JSON has a metadata portion along with the data segment.

```{r JSON PIC1, out.width = "400px", echo=FALSE}
knitr::include_graphics("./files/JSON1.jpg")
```
```{r JSON PIC2, out.width = "400px", echo=FALSE}
knitr::include_graphics("./files/JSON2.jpg")
```
<br><br>
We have used the `jsonlite` package to read in the JSON file. 

```{r readJSON1, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
library(jsonlite)
library(tidyverse)
library(gdata)
library(ggplot2)

myJSON <- fromJSON("./files/DrugOverdose.json")
class(myJSON)
```
Let's examine the structure and attibutes a bit further.

```{r readJSON2, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
attributes(myJSON)
attributes(myJSON[['meta']])
attributes(myJSON[['meta']][['view']])
```
### Extract the column names.

From the webpage we have observed the JSON has 41 rows. By inspecting the column names metadata we can discard the first 9 columns and select the rest.

```{r readJSON3, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
colNames <-myJSON[['meta']][['view']][['columns']]
colNames<- colNames[c(9:50),2]
colNames
```

### Extract the Data Portion

Let's examine the data segment of the JSON file in the JSON editor/browser.

```{r JSON PIC3, out.width = "400px", echo=FALSE}
knitr::include_graphics("./files/JSON3.jpg")
```
<br><br>
We can see the data portion of the JSON file is a nested list and let's make sure the length of the top list matches the no of rows we have from the source page.

```{r readJSON4, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
myData <- myJSON[['data']]
length(myData)
```
### Generate Data Frame from JSON

This custom function reads the list data and convert that to a data frame and tibble. The DeathCityGeo, ResidenceCityGeo and InjuryCityGeo are nested list. The function reads the lattitude and longtitude from those nested lists.

```{r readJSON5, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
collectData<-function(var){
  sapply(myData, function(x) returnData(x, var)) 
}

returnData<-function(x, var){
  if(length(x[[var]]) > 1){
    return(trim(paste(x[[var]][[2]], x[[var]][[3]], sep = ",")))
  }
  else{
    if(!is.null( x[[var]])){
    return( trim(x[[var]]))
  }else{
    return(NA)
  }
  }
}

drugDF<-data.frame(sapply(9:50, collectData), stringsAsFactors=FALSE)

drugOverDoseTD <- tbl_df(drugDF)
colnames(drugOverDoseTD) <- colNames
drugOverDoseTD
```
Convert the Age and Town Index to numeric and the date column to date type.

```{r convertJSON1, echo=TRUE, message=FALSE, warning=FALSE, error=TRUE}
drugOverDoseTD['Age'] <- as.numeric(drugOverDoseTD$Age)
drugOverDoseTD['Town Index'] <- as.numeric(drugOverDoseTD$`Town Index`)
drugOverDoseTD['Date'] <- as.Date(drugOverDoseTD$Date)
```